# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Development Commands

**Essential Development Scripts:**
- `pnpm dev` - Start local development server (auto-applies migrations, runs on localhost:8787)
- `pnpm deploy` - Deploy to production (auto-applies remote migrations)  
- `pnpm test` - Run integration tests with Vitest + Workers pool
- `pnpm schema` - Generate OpenAPI schema (converts 3.1→3.0.3 for Dify compatibility)
- `pnpm seedLocalDb` - Apply migrations to local D1 database only
- `pnpm run cf-typegen` - Generate Cloudflare Workers types

**Testing:**
- Tests use Vitest with @cloudflare/vitest-pool-workers for Cloudflare Workers environment
- Tests are in `tests/` directory with `.test.ts` files
- Test config: `tests/vitest.config.mts`

## Architecture Overview

**Tech Stack:**
- **Runtime**: Cloudflare Workers
- **Framework**: Hono (lightweight web framework)
- **Database**: Cloudflare D1 (SQLite-based)
- **ORM**: Drizzle ORM with TypeScript
- **API Docs**: Chanfana (auto-generates OpenAPI from Hono routes)
- **Package Manager**: pnpm

**Core Structure:**
```
src/
├── index.ts              # Main app setup, OpenAPI config, global error handling
├── db/
│   ├── schema.ts         # Drizzle schema definitions (customers, chat_history, reservations, tasks)
│   └── index.ts          # Database connection
├── endpoints/            # API routes organized by domain
│   ├── customers/        # Customer CRUD operations
│   ├── chat-history/     # Chat history management  
│   └── reservations/     # Reservation management
├── middleware/
│   └── auth.ts          # Bearer token authentication
└── types.ts             # Shared TypeScript types
```

**Authentication:**
- All API endpoints require `Authorization: Bearer <APIKEY>` header
- API key stored in Cloudflare Workers secrets (production) or `.dev.vars` (local)
- Authentication middleware protects `/customers/*`, `/chat/*`, `/reservations/*`
- Root path `/` serves public Swagger UI documentation

**Database Schema:**
- `customers` - Core customer data with unique email constraint
- `chat_history` - Stores conversation history (customer_id as text, no FK constraint)
- `reservations` - Booking/appointment data linked to customers
- `tasks` - Sample/demo table
- Migrations in `migrations/` directory, applied via Wrangler CLI

**API Design:**
- RESTful endpoints following consistent patterns
- Pagination support (`page`, `per_page` parameters, default per_page=20, max=100)
- Standardized error responses: `{ success: false, errors: [{ code, message, path? }] }`
- OpenAPI 3.1 generated by Chanfana, converted to 3.0.3 for Dify tool integration

**Key Files:**
- `wrangler.jsonc` - Cloudflare Workers configuration including D1 binding
- `scripts/convert-openapi-31-to-30.mjs` - Converts OpenAPI schema for Dify compatibility
- `.dev.vars` - Local environment variables (not committed, use `.dev.vars.example`)

**Integration Notes:**
- Designed for Dify AI tool integration via OpenAPI schema
- Schema conversion handles Dify's OpenAPI 3.0.3 requirement and nullable type issues
- Base URL in OpenAPI schema comes from `DEPLOY_URL` constant in `src/lib/constant.ts`